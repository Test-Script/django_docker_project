# ---------- Builder ----------
FROM registry.access.redhat.com/ubi8/ubi:8.1 AS builder

# Install Python 3.12 (UBI doesn't have it by default, so use python3.11 or python3 if 3.12 unavailable)
RUN dnf install -y python3 python3-pip python3-devel gcc make mysql-devel pkg-config \
    && dnf clean all

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

COPY requirements.txt /app/

# Upgrade pip and build wheels for dependencies
RUN python3 -m pip install --upgrade pip wheel \
 && python3 -m pip wheel --wheel-dir /wheels -r requirements.txt


# ---------- Runtime ----------
FROM registry.access.redhat.com/ubi8/ubi:8.1 AS runtime

# Install only runtime dependencies
RUN dnf install -y python3 python3-pip mysql-devel \
    && dnf clean all

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

# Copy built wheels from builder stage
COPY --from=builder /wheels /wheels
RUN python3 -m pip install --no-cache-dir /wheels/* \
 && rm -rf /wheels

# Copy app code
COPY --chown=10001:10001 . /app

# Create non-root user
RUN useradd -u 10001 -M -s /usr/sbin/nologin test

# Copy and give execute permission to script
COPY ./executable.sh /app/executable.sh
RUN chmod +x /app/executable.sh

ENTRYPOINT ["/app/executable.sh"]

USER 10001

EXPOSE 8000

CMD ["python3", "manage.py", "runserver", "0.0.0.0:8000"]
